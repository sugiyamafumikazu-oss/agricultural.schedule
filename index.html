<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriLogi v2: æ ½åŸ¹ãƒ»å‡ºè·ãƒ»é˜²é™¤çµ±åˆç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Chosen Palette: Earth & Growth (Stone/Green/Amber) -->
    <!-- Application Structure Plan: 
         Updated Structure for V2:
         1. Header: Status, Date, and now implies Weather context.
         2. Section 1 (Top): "Cultivation Schedule" (Gantt) & "Efficiency Metrics" (Donut).
         3. Section 2 (Middle Left): "Smart Pest Management" - Includes Weather input for accurate logs.
         4. Section 3 (Middle Right): "Management Log" - Table updated with Weather column.
         5. Section 4 (NEW - Bottom): "Harvest & Shipment Database" - Form to upload photos, record weight/quality/weather. Displays as a Gallery Grid.
         
         Why this structure?
         Separating "Inputs" (Pesticides) from "Outputs" (Harvest) is logical. 
         The Harvest section is visual (photos), placed at the bottom to allow the gallery to expand.
    -->

    <!-- Visualization & Content Choices:
         1. Goal: Harvest Photo Log -> Method: FileReader API + DOM Generation -> Justification: Allows user to see their "Database" of photos immediately.
         2. Goal: Weather Recording -> Method: Dropdown Selector (Emoji) -> Justification: Visual, fast, language-independent.
         3. Goal: Previous Charts -> Maintained as they are effective.
         CONFIRMATION: NO SVG graphics used. NO Mermaid JS used.
    -->

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f5f5f4; /* stone-100 */
        }
        
        .chart-container {
            position: relative;
            width: 100%;
            height: 250px;
            max-height: 300px;
        }
        
        .chart-container-large {
            position: relative;
            width: 100%;
            height: 300px;
            max-height: 400px;
        }

        /* Photo Upload Preview Styling */
        .photo-card {
            transition: transform 0.2s;
        }
        .photo-card:hover {
            transform: translateY(-2px);
        }
        .aspect-square-cover {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            border-radius: 0.5rem 0.5rem 0 0;
            background-color: #e7e5e4;
        }
    </style>
</head>
<body class="text-stone-800">

    <!-- Navbar -->
    <nav class="bg-white border-b border-stone-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-2xl font-bold text-green-700">AgriLogi</span>
                    <span class="ml-2 text-xs bg-amber-100 text-amber-800 px-2 py-0.5 rounded-full">v2.0 Photo DB</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-stone-500 text-right hidden sm:block">
                        <p>ç¾åœ¨åœ°: ç¬¬2åœƒå ´ (å¤é‡èœ)</p>
                        <p id="current-date" class="font-bold">2026å¹´5æœˆ15æ—¥</p>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

        <!-- Intro -->
        <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-green-500">
            <h1 class="text-2xl font-bold mb-2">çµ±åˆãƒ•ã‚¡ãƒ¼ãƒ ç®¡ç†ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h1>
            <p class="text-stone-600 leading-relaxed">
                ä½œæ¥­ã®åŠ¹ç‡åŒ–ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ã€è¾²è–¬ã®é©æ­£åˆ¤å®šã€ãã—ã¦<span class="font-bold text-green-700">åç©«ç‰©ã®å†™çœŸãƒ»å¤©å€™è¨˜éŒ²</span>ã¾ã§ã‚’ä¸€å…ƒç®¡ç†ã—ã¾ã™ã€‚
                ç”»åƒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚ˆã‚Šã€éå»ã®å‡ºè·å“è³ªã¨æ°—è±¡æ¡ä»¶ã®é–¢ä¿‚ã‚’è¦–è¦šçš„ã«æŒ¯ã‚Šè¿”ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
            </p>
        </div>

        <!-- Top Section: Stats & Schedule -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Efficiency Chart -->
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h2 class="text-lg font-bold mb-4 flex items-center">
                    <span class="text-xl mr-2">ğŸ“Š</span> ç¾åœ¨ã®ä½œæ¥­åŠ¹ç‡
                </h2>
                <div class="chart-container">
                    <canvas id="efficiencyChart"></canvas>
                </div>
                <div class="mt-4 text-sm text-stone-500 text-center">
                    <p>ç®¡ç†ä½œæ¥­ï¼ˆé˜²é™¤ãƒ»è¨˜éŒ²ï¼‰ã®å‰²åˆ: 25%</p>
                </div>
            </div>

            <!-- Schedule Chart -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm">
                <h2 class="text-lg font-bold mb-4 flex items-center">
                    <span class="text-xl mr-2">ğŸ“…</span> æ ½åŸ¹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
                </h2>
                <div class="chart-container-large">
                    <canvas id="scheduleChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Middle Section: Pest Management (Input) & Log (Data) -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
            
            <!-- 1. Smart Pest Control Panel -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200 h-full">
                <div class="border-b border-stone-200 pb-4 mb-4">
                    <h2 class="text-xl font-bold text-stone-800 flex items-center">
                        <span class="bg-red-100 text-red-600 p-2 rounded-lg mr-3 text-2xl">ğŸ›¡ï¸</span>
                        é˜²é™¤åˆ¤å®šãƒ»è¨˜éŒ²
                    </h2>
                    <p class="text-sm text-stone-500 mt-1">è¾²è–¬ã®å®‰å…¨æ€§ï¼ˆå›æ•°ãƒ»æŠµæŠ—æ€§ï¼‰ã‚’åˆ¤å®šã—ã€å¤©å€™ã¨å…±ã«è¨˜éŒ²ã—ã¾ã™ã€‚</p>
                </div>

                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-stone-500 uppercase mb-1">å¯¾è±¡ (Target)</label>
                            <select id="targetPest" class="w-full p-2 border border-stone-300 rounded bg-stone-50">
                                <option value="aphid">ã‚¢ãƒ–ãƒ©ãƒ ã‚·é¡</option>
                                <option value="caterpillar">ã‚¢ã‚ªãƒ ã‚·é¡</option>
                                <option value="mite">ãƒãƒ€ãƒ‹é¡</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-stone-500 uppercase mb-1">å¤©å€™ (Weather)</label>
                            <select id="sprayWeather" class="w-full p-2 border border-stone-300 rounded bg-stone-50 text-xl">
                                <option value="â˜€ï¸">â˜€ï¸ æ™´ã‚Œ</option>
                                <option value="â˜ï¸">â˜ï¸ æ›‡ã‚Š</option>
                                <option value="â˜‚ï¸">â˜‚ï¸ å°é›¨</option>
                                <option value="ğŸ’¨">ğŸ’¨ å¼·é¢¨ (æ³¨æ„)</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-stone-500 uppercase mb-1">è–¬å‰¤é¸æŠ (Chemical)</label>
                        <select id="chemicalSelect" class="w-full p-2 border border-stone-300 rounded bg-stone-50">
                            <!-- Populated via JS -->
                        </select>
                    </div>

                    <button id="checkButton" class="w-full bg-stone-800 hover:bg-stone-900 text-white font-bold py-3 px-4 rounded shadow transition">
                        åˆ¤å®šå®Ÿè¡Œ (Check Safety)
                    </button>

                    <!-- Result Area -->
                    <div id="resultPanel" class="bg-stone-50 rounded p-4 text-center border-2 border-dashed border-stone-200 mt-4 min-h-[120px] flex flex-col justify-center items-center">
                        <p class="text-stone-400 text-sm">åˆ¤å®šçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    </div>
                </div>
            </div>

            <!-- 2. Management Log Table -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200 h-full flex flex-col">
                <h2 class="text-lg font-bold mb-4 flex items-center">
                    <span class="text-xl mr-2">ğŸ“</span> é˜²é™¤å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
                </h2>
                <div class="overflow-y-auto custom-scrollbar flex-grow max-h-[400px]">
                    <table class="min-w-full text-sm text-left text-stone-600">
                        <thead class="text-xs text-stone-700 uppercase bg-stone-100 sticky top-0">
                            <tr>
                                <th class="px-3 py-2">æ—¥ä»˜</th>
                                <th class="px-3 py-2">å¤©å€™</th>
                                <th class="px-3 py-2">è–¬å‰¤å</th>
                                <th class="px-3 py-2">ç³»çµ±</th>
                                <th class="px-3 py-2">åˆ¤å®š</th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody">
                            <!-- JS Populated -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 pt-4 border-t border-stone-100 text-right">
                    <span class="text-xs text-stone-400">â€» å¤©å€™ã¯æ•£å¸ƒæ™‚ã®è¨˜éŒ²ã§ã™</span>
                </div>
            </div>
        </div>

        <!-- Bottom Section: Harvest & Shipment Recorder (NEW) -->
        <div class="bg-white p-6 rounded-lg shadow-sm border-t-4 border-amber-500">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <div>
                    <h2 class="text-xl font-bold text-stone-800 flex items-center">
                        <span class="text-2xl mr-2">ğŸ“¦</span> åç©«ãƒ»å‡ºè·ãƒ•ã‚©ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
                    </h2>
                    <p class="text-stone-500 text-sm mt-1">å‡ºè·æ™‚ã®è·å§¿ã‚„ä½œç‰©ã®çŠ¶æ…‹ã‚’å†™çœŸã§ä¿å­˜ã—ã€å“è³ªç®¡ç†ã«å½¹ç«‹ã¦ã¾ã™ã€‚</p>
                </div>
                <button onclick="document.getElementById('harvestForm').classList.toggle('hidden')" class="mt-4 md:mt-0 text-amber-600 border border-amber-600 hover:bg-amber-50 px-4 py-2 rounded text-sm font-bold transition">
                    + æ–°è¦è¨˜éŒ²ã‚’è¿½åŠ 
                </button>
            </div>

            <!-- Add New Harvest Record Form -->
            <div id="harvestForm" class="hidden bg-amber-50 p-6 rounded-lg mb-8 border border-amber-200">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-stone-600 mb-1">å“ç›® (Item)</label>
                        <input type="text" id="harvestItem" value="å¤ç§‹ãƒˆãƒãƒˆ" class="w-full p-2 border border-stone-300 rounded">
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-stone-600 mb-1">åç©«é‡ (kg)</label>
                        <input type="number" id="harvestWeight" placeholder="ä¾‹: 20" class="w-full p-2 border border-stone-300 rounded">
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-stone-600 mb-1">å½“æ—¥ã®å¤©å€™</label>
                        <select id="harvestWeather" class="w-full p-2 border border-stone-300 rounded bg-white text-lg">
                            <option value="â˜€ï¸">â˜€ï¸ æ™´ã‚Œ</option>
                            <option value="â˜ï¸">â˜ï¸ æ›‡ã‚Š</option>
                            <option value="â˜”">â˜” é›¨</option>
                        </select>
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-stone-600 mb-1">å†™çœŸ (Photo)</label>
                        <input type="file" id="harvestPhoto" accept="image/*" class="w-full text-xs text-stone-500 file:mr-2 file:py-2 file:px-4 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-amber-100 file:text-amber-700 hover:file:bg-amber-200">
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button onclick="addHarvestRecord()" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-6 rounded shadow transition">
                        ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
                    </button>
                </div>
            </div>

            <!-- Gallery Grid -->
            <div id="harvestGallery" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Cards injected by JS -->
            </div>
            
            <div id="emptyGalleryMsg" class="text-center py-10 text-stone-400">
                <p>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œæ–°è¦è¨˜éŒ²ã‚’è¿½åŠ ã€ã‹ã‚‰å†™çœŸã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
        </div>

    </main>

    <footer class="bg-stone-800 text-stone-400 py-8 mt-12 text-center text-sm">
        <p>&copy; 2026 AgriLogi v2.0 Smart Database System.</p>
    </footer>

    <!-- Logic -->
    <script>
        // --- 1. Data Definitions ---
        const TODAY = new Date('2026-05-15');
        document.getElementById('current-date').textContent = TODAY.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });

        // Pesticide DB
        const PESTICIDE_DB = {
            'admi': { name: 'ã‚¢ãƒ‰ãƒã‚¤ãƒ¤ãƒ¼', group: '4A', target: ['aphid'], maxCount: 3, desc: 'å®šæ¤æ™‚å‡¦ç†æ¨å¥¨' },
            'mosa': { name: 'ãƒ¢ã‚¹ãƒ”ãƒ©ãƒ³', group: '4A', target: ['aphid', 'caterpillar'], maxCount: 3, desc: 'é€ŸåŠ¹æ€§ã‚ã‚Š' },
            'bene': { name: 'ãƒ™ãƒãƒ“ã‚¢OD', group: '28', target: ['aphid', 'caterpillar'], maxCount: 3, desc: 'æ½…æ³¨å‡¦ç†ã‚‚å¯' },
            'ulala': { name: 'ã‚¦ãƒ©ãƒ©DF', group: '9C', target: ['aphid'], maxCount: 3, desc: 'ã‚¢ãƒ–ãƒ©ãƒ ã‚·ç‰¹åŠ¹' },
            'sumi': { name: 'ã‚¹ãƒŸãƒã‚ªãƒ³', group: '1B', target: ['aphid'], maxCount: 5, desc: 'åºƒç¯„å›²ã«åŠ¹ã' }
        };

        // Usage Log (with Weather)
        let usageHistory = [
            { date: '2026-04-10', weather: 'â˜€ï¸', code: 'admi', name: 'ã‚¢ãƒ‰ãƒã‚¤ãƒ¤ãƒ¼', group: '4A', status: 'OK' },
            { date: '2026-04-25', weather: 'â˜ï¸', code: 'mosa', name: 'ãƒ¢ã‚¹ãƒ”ãƒ©ãƒ³', group: '4A', status: 'OK' },
            { date: '2026-05-02', weather: 'â˜”', code: 'bene', name: 'ãƒ™ãƒãƒ“ã‚¢', group: '28', status: 'OK' }
        ];

        // Harvest Data (Mock)
        let harvestData = [
            { id: 1, date: '2026-05-10', item: 'å¤ç§‹ãƒˆãƒãƒˆ', weight: 45, weather: 'â˜€ï¸', img: null }, // Null img uses placeholder
        ];

        // --- 2. Chart Inits ---
        function initCharts() {
            // Schedule
            new Chart(document.getElementById('scheduleChart'), {
                type: 'bar',
                data: {
                    labels: ['åœŸä½œã‚Š', 'å®šæ¤', 'ç®¡ç†ãƒ»é˜²é™¤', 'åç©«'],
                    datasets: [{
                        label: 'è¨ˆç”»',
                        data: [[1, 20], [25, 30], [35, 100], [60, 110]], // Simplified numeric range for demo
                        backgroundColor: ['#d6d3d1', '#86efac', '#22c55e', '#f59e0b'],
                        borderRadius: 5
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} } }
            });

            // Efficiency
            new Chart(document.getElementById('efficiencyChart'), {
                type: 'doughnut',
                data: {
                    labels: ['ä½œæ¥­', 'é˜²é™¤', 'è¨˜éŒ²'],
                    datasets: [{
                        data: [60, 25, 15],
                        backgroundColor: ['#22c55e', '#f59e0b', '#78716c'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position:'right'} } }
            });
        }

        // --- 3. Pesticide Logic (Updated with Weather) ---
        function updatePesticideOptions() {
            const target = document.getElementById('targetPest').value;
            const select = document.getElementById('chemicalSelect');
            select.innerHTML = '';
            for (const [key, val] of Object.entries(PESTICIDE_DB)) {
                if (val.target.includes(target)) {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = `${val.name} (ç³»çµ±:${val.group})`;
                    select.appendChild(opt);
                }
            }
        }

        function checkPesticide() {
            const code = document.getElementById('chemicalSelect').value;
            const weather = document.getElementById('sprayWeather').value;
            const pest = PESTICIDE_DB[code];
            const panel = document.getElementById('resultPanel');

            // Logic
            const usedCount = usageHistory.filter(h => h.code === code).length;
            const lastSpray = usageHistory[usageHistory.length - 1];
            const isConsecutive = lastSpray && lastSpray.group === pest.group;

            let html = '';
            let isSafe = true;

            if (isConsecutive) {
                isSafe = false;
                html = `<h3 class="text-red-600 font-bold">ğŸš« é€£ç”¨è­¦å‘Š (Rotation Alert)</h3><p class="text-sm">å‰å›ã¨åŒã˜ç³»çµ±(${pest.group})ã§ã™ã€‚æŠµæŠ—æ€§ãŒã¤ãã¾ã™ã€‚</p>`;
            } else if (usedCount >= pest.maxCount) {
                isSafe = false;
                html = `<h3 class="text-red-600 font-bold">âš ï¸ å›æ•°è¶…é</h3><p class="text-sm">ä½¿ç”¨é™åº¦ã«é”ã—ã¦ã„ã¾ã™ã€‚</p>`;
            } else {
                html = `<h3 class="text-green-600 font-bold">âœ… ä½¿ç”¨å¯èƒ½ (Safe)</h3>
                        <p class="text-sm text-stone-600">ç³»çµ±:${pest.group} / å›æ•°:${usedCount+1}å›ç›®</p>
                        <p class="text-sm mt-1 font-bold">å¤©å€™è¨˜éŒ²: ${weather}</p>
                        <button onclick="addLog('${code}', '${weather}')" class="mt-3 bg-green-600 text-white px-4 py-1 rounded text-sm hover:bg-green-700">è¨˜éŒ²ã«è¿½åŠ </button>`;
            }
            
            panel.innerHTML = html;
        }

        window.addLog = function(code, weather) {
            const pest = PESTICIDE_DB[code];
            usageHistory.push({
                date: TODAY.toISOString().split('T')[0],
                weather: weather,
                code: code,
                name: pest.name,
                group: pest.group,
                status: 'OK'
            });
            renderLogTable();
            document.getElementById('resultPanel').innerHTML = `<p class="text-green-600 font-bold">è¨˜éŒ²ã—ã¾ã—ãŸï¼</p>`;
        };

        function renderLogTable() {
            const tbody = document.getElementById('logTableBody');
            tbody.innerHTML = '';
            [...usageHistory].reverse().forEach(log => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-stone-50';
                tr.innerHTML = `
                    <td class="px-3 py-2 text-stone-500">${log.date}</td>
                    <td class="px-3 py-2 text-lg">${log.weather}</td>
                    <td class="px-3 py-2 font-bold text-stone-700">${log.name}</td>
                    <td class="px-3 py-2"><span class="bg-stone-200 text-xs px-2 py-1 rounded">${log.group}</span></td>
                    <td class="px-3 py-2 text-green-600 text-xs">â— ${log.status}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 4. Harvest & Shipment Logic (Photo Handling) ---
        
        function renderHarvestGallery() {
            const gallery = document.getElementById('harvestGallery');
            const msg = document.getElementById('emptyGalleryMsg');
            
            gallery.innerHTML = '';
            
            if (harvestData.length === 0) {
                msg.classList.remove('hidden');
            } else {
                msg.classList.add('hidden');
                harvestData.forEach(item => {
                    // Create Card
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow photo-card border border-stone-200 overflow-hidden';
                    
                    // Image Handling (Placeholder if null)
                    const imgSrc = item.img ? item.img : 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNlNWU3ZWIiLz48dGV4dCB4PSI1MCIgeT0iNTAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOWNhMzFmIj5NoCBQaG90bzwvdGV4dD48L3N2Zz4='; // Canvas generated placeholder actually preferred but data URI ok for placeholder
                    
                    card.innerHTML = `
                        <img src="${imgSrc}" class="aspect-square-cover" alt="Harvest Photo">
                        <div class="p-3">
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="font-bold text-stone-800">${item.item}</h3>
                                <span class="text-xl" title="å¤©å€™">${item.weather}</span>
                            </div>
                            <p class="text-xs text-stone-500 mb-2">${item.date}</p>
                            <div class="flex justify-between items-center text-sm bg-amber-50 p-2 rounded">
                                <span class="text-amber-800 font-bold">${item.weight}kg</span>
                                <span class="text-stone-400 text-xs">å‡ºè·æ¸ˆ</span>
                            </div>
                        </div>
                    `;
                    gallery.prepend(card); // Newest first
                });
            }
        }

        // Add Record Function
        window.addHarvestRecord = function() {
            const item = document.getElementById('harvestItem').value;
            const weight = document.getElementById('harvestWeight').value;
            const weather = document.getElementById('harvestWeather').value;
            const fileInput = document.getElementById('harvestPhoto');
            
            if (!item || !weight) {
                alert('å“ç›®ã¨é‡é‡ã¯å¿…é ˆã§ã™');
                return;
            }

            const processRecord = (imgData) => {
                harvestData.push({
                    id: Date.now(),
                    date: TODAY.toISOString().split('T')[0],
                    item: item,
                    weight: weight,
                    weather: weather,
                    img: imgData
                });
                renderHarvestGallery();
                document.getElementById('harvestForm').classList.add('hidden');
                // Reset form
                document.getElementById('harvestWeight').value = '';
                fileInput.value = '';
            };

            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    processRecord(e.target.result); // Base64 string
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                processRecord(null); // No image
            }
        };

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            updatePesticideOptions();
            renderLogTable();
            renderHarvestGallery();

            document.getElementById('targetPest').addEventListener('change', updatePesticideOptions);
            document.getElementById('checkButton').addEventListener('click', checkPesticide);
        });
    </script>
</body>
</html>
